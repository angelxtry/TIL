# 만들면서 배우는 아마존 버추얼 프라이빗 클라우드(Amazon VPC)

## Q & A

Q. VPC를 생성했을 때 반드시 고려해야할 리소스는 무엇이 있을까요?

A. 

- VPC 1개
- Subnet n개
- Route Table 1
- Network ACL 1
- Security Group 1
- Internet Gateway 1
- DHCP options set 1

Q. AWS VPC에서 사용가능한 사설망 대역은?

A. `10.0.0.0/8`, `172.16.0.0/12`, `192.168.0.0/16`

Q. VPC에서 사설망 대역을 사용해야 하는 이유는 무엇인가요?

A. VPC에서 사설망의 CIDR 블럭을 사용해야 하는 이유는 라우트 테이블의 기본 규칙이 VPC의 CIDR 블럭에 의해 점유되기 때문입니다. 따라서 사설망이 아닌 CIDR을 사용하면 인터넷과 연결하는 라우트 규칙을 정의하더라도 통신할 수 없습니다. 같은 이유로 사설망에 해당하는 CIDR 블럭을 사용하더라도, 다른 VPC와 통신할 때 CIDR이 겹치는 부분과는 통신할 수 없습니다.

---

2011년 8월에 처음 릴리즈되었습니다. 현재는 AWS에서 제공하는 대부분의 서비스가 VPC에 의존적입니다.

AWS에서 계정 생성 시 함께 생성되는 default VPC 때문에 별도로 설정하지 않아도 AWS 사용에 문제가 없습니다.

## Amazon VPC의 이해

AWS VPC 공식 웹페이지에서 다음과 같이 소개하고 있습니다.

> Amazon Virtual Private Cloud(VPC)를 사용하면 AWS 클라우드에서 논리적으로 격리된 공간을 프로비저닝하여 고객이 정의하는 가상 네트워크에서 AWS 리소스를 시작할 수 있습니다. IP 주소 범위 선택, 서브넷 생성, 라우팅 테이블 및 네트워크 게이트웨이 구성 등 가상 네트워킹 환경을 완벽하게 제어할 수 있습니다. VPC에서 IPv4와 IPv6를 모두 사용하여 리소스와 애플리케이션에 안전하고 쉽게 액세스할 수 있습니다.

간단히 표현하자면 VPC는 하나의 계정에서 생성하는 리소스들만의 격리된 네트워크를 만들 수 있습니다.

이 글의 최종 목표는 기본 VPC의 구성 요소들을 알고, 마법사를 사용하지 않고 기본 VPC를 직접 만들 수 있게 되는 것입니다.

## AWS VPC는 언제 사용할까요?

EC2 인스턴스를 생성할 때 Network를 설정할 수 있습니다. 이 Network를 설정하는 것이 VPC를 설정하는 것입니다. 인스턴스는 반드시 VPC를 설정해야 합니다.

Network 아래의 Subnet도 VPC 리소스 중 하나입니다.

RDS도 생성 시 반드시 VPC를 설정해야 합니다. Lambda는 VPC를 지정하지 않고 실행할 수 있지만, 이 경우 VPC 내부에서만 접근가능한 리소스를 사용할 수 없습니다.

VPC는 중의적인 이름입니다. VPC 그 자체가 리소스 이름이면서 AWS에서 제공하는 별도 서비스의 이름이기도 합니다. 웹 콘솔에서 VPC Dashboard에 접속할 수 있습니다.

## 기본 VPC의 구성 요소들

계정을 처음 만들면 하나의 리전에서 생성되는 리소스들은 다음과 같습니다.

- VPC 1개
- Subnet n개
- Route Table 1
- Network ACL 1
- Security Group 1
- Internet Gateway 1
- DHCP options set 1

VPC를 처음 시작할 때는 이 7개를 알고 있으면 수월합니다.

### 1. VPC

VPC는 프라이빗 클라우드를 만드는 데 가장 기본이 되는 리소스입니다. 논리적인 독립 네트워크를 구성하는 리소스로 이름과 IPv4 CIDR 블록을 필수적으로 가집니다.

CIDR 블록은 IP 범위를 지정하는 방식입니다. CIDR 블록은 IP 주소와 슬래시 뒤에 따라오는 넷마스크 숫자로 구성됩니다. 넷마스크 숫자는 IP 범위를 나타냅니다. 넷마스크 32는 정확히 하나의 IP를 가리킵니다. 정확히 계산하자면 지정된 IP부터 2^(32-n)개가 됩니다. 예를 들어 24라면 2^(32-24) = 256 개의 IP 주소를 의합니다. `192.168.0.0/24`는 192.168.0.0에서 192.168.0.255 까지의 IP를 의미합니다.

클라우드에서 생성하는 자원들은 기본적으로 특정 네트워크 위에서 생성되며 private IP를 가집니다. 이 IP는 특정한 VPC 위에서 만들어집니다. 따라서 해당 VPC의 CIDR 범위 안에서 적절한 IP를 할당받습니다. VPC 범위 내에서 할당 가능한 IP가 모두 할당되면 더 이상 리소스를 만들 수 없습니다. 하나의 VPC의 최대 크기는 16입니다. 이 경우 2^(32-16) = 65536 개의 IP를 사용할 수 있습니다.

VPC를 만들 때 고려해야 할 점이 하나 더 있습니다. CIDR의 범위를 지정하는데 특별한 제약은 없지만, Public IP 대역을 사용하면 인터넷과 연결되어 있는 경우 문제가 발생할 수 있습니다. 따라서 가능하면 사설망 대역을 사용하는 것을 권장합니다. 사설망 대역은 `10.0.0.0/8`, `172.16.0.0/12`, `192.168.0.0/16`을 사용가능 합니다.

다수의 VPC를 함께 사용하는 경우 IP 대역이 겹치면 문제가 발생할 수 있습니다. 문제가 생겨서 VPC 내부의 모든 자원을 이동하는 것은 매우 힘든 일입니다. 프로덕션 환경을 구축할 때는 VPC 제약사항들을 충분히 이해하고 CIDR을 정하는 것이 좋습니다. 기본 VPC의 CIDR 블록은 `172.31.0.0/16` 입니다.

### 2. Subnet

VPC는 다시 한 번 CIDR 블록을 가지는 단위로 나누어집니다. 서브넷은 실제로 리소스가 생성되는 물리적인 공간인 Available Zone과 연결됩니다.

VPC가 논리적인 범위를 의미한다면 서브넷은 VPC 안에서 실제로 리소스가 생성될 수 있는 네트워크로 생각할 수 있습니다. 다른 서비스의 리소스를 생성할 때 VPC만 지정하는 경우는 없습니다. VPC와 서브넷을 모두 지정하거나 서브넷을 지정하면 VPC는 자동으로 유추되기도 합니다.

하나의 VPC는 N개의 서브넷을 가질 수 있습니다. 서브넷의 최대 크기는 VPC의 크기와 같습니다. N가용존만큼 서브넷을 만들어 리소스를 분산하면 재해 대응 측면에서도 유리합니다.

서브넷의 넷마스크 범위는 16(65535개)에서 28(16개)을 사용할 수 있으며, VPC CIDR 블럭 범위에 속하는 CIDR 블럭을 지정할 수 있습니다. 하나의 서브넷은 하나의 가용존과 연결됩니다. 리전에 따라서 사용가능한 가용존의 갯수는 다릅니다. 재해 대응을 위해 가용존만큼 서브넷을 나누는 경우 특정 리전에서 사용가능한 가용존의 갯수를 미리 확인해야 합니다. 보통 2개 이상의 가용존을 사용합니다. 기본 VPC에서는 가용존 갯수만큼 넷마스크 20의 서브넷들을 자동으로 생성합니다.

### 3. Route Table

라우트 테이블은 서브넷과 연결되어 있는 리소스입니다. 서브넷에서 네트워크를 이용할 때 라우트 테이블을 사용해서 목적지를 찾게 됩니다. 라우트 테이블은 서브넷과 연결되어 있지만 VPC를 생성할 때 만들어지고 VPC에도 연결되어 있습니다.

하나의 라우트 테이블은 VPC에 속한 다수의 서브넷에서 사용할 수 있습니다. 자동 생성되는 라우트 테이블에는 한 가지 룰만이 정의되어 있습니다. VPC의 CIDR 블럭을 목적지로 하는 경우 타깃이 local인 규칙입니다. 예를 들어 VPC의 CIDR 블럭이 172.31.0.0/16일 때 이 네트워크 안에서 목적지가 172.31.0.0/16 범위에 있는 리소스를 찾는다면 VPC 내부에서 찾습니다. 이 규칙은 삭제할 수 없습니다. 인터넷을 연결하거나 다른 VPC와 통신하기 위해서는 라우트 테이블에 라우트 규칙을 추가로 정의해야 합니다.

앞서 설명한 VPC에서 사설망의 CIDR 블럭을 사용해야 하는 이유는 라우트 테이블의 기본 규칙이 VPC의 CIDR 블럭에 의해 점유되기 때문입니다. 따라서 사설망이 아닌 CIDR을 사용하면 인터넷과 연결하는 라우트 규칙을 정의하더라도 통신할 수 없습니다. 같은 이유로 사설망에 해당하는 CIDR 블럭을 사용하더라도, 다른 VPC와 통신할 때 CIDR이 겹치는 부분과는 통신할 수 없습니다.

### 4. Internet Gateway

VPC는 격리된 네트워크 환경입니다. VPC에서 생성된 리소스들은 기본적으로 인터넷을 사용할 수 없습니다. 인터넷에 연결하기 위해서는 인터넷 게이트웨이가 필요합니다. 라우팅 테이블에 인터넷 게이트웨이를 향하는 적절한 규칙을 추가하면 특정 서브넷이 인터넷과 연결됩니다. 하지만 서브넷과 인터넷 게이트웨이를 연결하는 것만으로는 인터넷을 사용할 수 없습니다. 인터넷을 사용하고자 하는 리소스는 퍼블릭 IP를 가지고 있어야 합니다.

### 5. DHCP options set

DHCP 옵션셋은 TCP/IP 네트워크 상의 호스트로 설정 정보를 전달하는 DHCP 표준입니다. 이 기능을 사용하면 DNS, NTP 서버, NetBIOS 서버 등의 정보를 설정할 수 있습니다. 일반적으로 VPC 생성 시 만들어지는 DHCP 옵션셋을 그대로 사용합니다.

### 6. Network ACL / Security Group

네트워크 ACL은 outbound, inbound 트래픽을 제어하는 가상 방화벽입니다. 하나의 네트워크 ACL은 다수의 서브넷에서 재사용할 수 있습니다. 시큐리티 그룹은 인스턴스 앞단에서 트래픽을 제어하는 가상 방화벽인 반면, 네트워크 ACL은 서브넷 앞단에서 트래픽을 제어하는 역할을 합니다.

네트워크 ACL 규칙을 통과하더라도 시큐리티 그룹의 규칙을 통과하지 못하면 인스턴스와는 통신하지 못합니다.

## 첫 번째 스탭: VPC 생성하기

기본 VPC가 필요한 상황에서 실수로 삭제했다면 아마존 지원 센터에 문의하면 복구할 수 있습니다. 기본 VPC는 특별한 기능이 있는 것은 아닙니다. 동일하게 설정할 수 있다면 다시 생성해도 동일하게 동작합니다.

VPC -> Your VPCs -> Create VPC

VPC를 생성할 때 설정해야 할 값은 4가지가 있습니다. Name tag는 중요하지만 선택사항입니다. 필수적으로 입력해야 하는 값은 IPv4 CIDR block 하나 뿐입니다. 이 값은 특별한 이유가 없다면 반드시 사설망 대역 범위 내에서 지정해야 합니다. `10.0.0.0/8`, `172.16.0.0/12`, `192.168.0.0/16`

이름 태그를 New Default, IPv4 CIDR 블록은 10.10.0.0/16으로 지정하고 VPC를 생성합니다.

생성 후 DNS resolution과 DNS hostnames을 확인해야 합니다.

2020-01-28 기준 DNS resolution은 Enable, DNS hostnames는 Disabled 로 기본 설정되어 있습니다.

DNS resolution은 DNS hostname을 IP로 해석할 때 AWS에서 제공하는 DNS 서버를 사용하는 기능힙니다.

DNS hostnames은 VPC 내부에서 생성되는 인스턴스에 퍼블릭 DNS 호스트네임을 할당하는 기능입니다. DNS hostnames은 비활성화되어 있습니다.

VPC 선택 -> Actions -> Edit DNS hostnames를 선택하여 이 기능을 활성화합니다.

VPC와 함께 만들어진 리소스를 확인해봅시다.

### 라우트 테이블

라우트 테이블은 자동으로 생성되면서 하나의 룰이 자동으로 설정됩니다. 이 룰은 VPC 내부의 다른 자원을 찾을 때 사용하는 룰입니다.

### DHCP option set

별 다른 설정없이 기본값을 그대로 사용합니다.

### 네트워크 ACL

ACL은 서브넷 앞단에서 방화벽 역할을 합니다.

VPC를 생성할 때 자동으로 inbound, outbound 각각 규칙 2개가 자동으로 생성됩니다.

Rule Number가 높은 것 부터 순차적으로 적용됩니다. 마지막으로 `*` 규칙은 정의된 모든 규칙에 매칭되는 것이 없을 경우 적용됩니다.

자동으로 생성된 규칙을 보면 100번 규칙이 모든 트래픽을 통과시킵니다. 모든 트래픽에 100번 규칙이 적용되므로 `*` 규칙은 적용되지 않습니다.

### 시큐리티 그룹

ACL이 서브넷의 트래픽을 제어한다면 시큐리티 그룹은 인스턴스의 트래픽을 제어합니다. 

자동으로 생성된 inbound, outbound 규칙을 살펴봅시다. outbound는 모든 트래픽을 허용하도록 설정되어 있습니다.

inbound의 소스에 CIDR을 지정할 수 있습니다. CIDR 대신 시큐리티 그룹의 ID를 지정하면 해당 시큐리티 그룹을 가진 리소스에 대해서만 트래픽을 허용하는 것이 가능합니다. 자동으로 생성된 inbound 규칙을 보면 소스가 시큐리티 그룹 자기 자신의 ID 입니다. 이렇게 설정하면 이 규칙을 가진 인스턴스들 간에 트래픽을 허용합니다. VPC 내부의 리소스들 간에 통신을 허용하려면 각 리소스들이 이 시큐리티 그룹을 사용해야 합니다.

## 두 번째 스탭: 서브넷 만들기

VPC는 논리적인 구획만 나누기 때문에 이것만으로는 아무것도 할 수 없습니다. 특정 VPC에 바로 EC2 인스턴스를 만들 수 없습니다. 이러한 리소스들은 VPC 안에서 가용존과 연결된 서브넷 위에 만들어 집니다.

좌측 사이드바의 Subnets -> 우측 상단의 Create subnet 버튼을 클릭합니다.

먼저 VPC ID를 클릭하면 하단에서 자세한 설정을 할 수 있습니다.

Subnet name을 설정하고 가용존을 지정합니다. 가용존은 리전에 따라 다릅니다. 버지니아 리전은 a부터 f까지 6개가 있습니다. 기본 옵션은 No preference를 선택하면 6개 중 하나가 자동으로 선택됩니다.

VPC의 CIDR을 `10.10.0.0/16`으로 설정했으므로 서브넷의 IPv4 CIDR block은 이 범위 내의 CIDR을 설정해야 합니다. `10.10.0.0 ~ 10.10.255.255` 중에서 `10.10.0.0 ~ 10.10.0.255`를 설정합니다. CIDR로 표현하면 `10.10.0.0/24` 입니다.

다음과 같이 2개의 서브넷을 생성합시다.

```txt
Subnet01 us-east-1a 10.10.0.0/24
Subnet02 us-east-1b 10.10.1.0/24
```

생성된 서브넷의 라우트 테이블과 네트워크 ACL을 살펴보면 VPC 생성 시 만들어진 값들이 동일하게 설정되어 있는 것을 확인할 수 있습니다.

왜 서브넷을 2개 만들었을까요? EC2를 비롯한 많은 AWS 서비스에서는 멀티 AZ라는 개념을 지원합니다. 이것은 하나 이상의 가용존에 유사한 리소스를 동시에 배치하는 기능입니다. 하나의 리전에는 다수의 가용존이 존재합니다. 이 가용존은 물리적인 공간도 분리되어 있습니다. 다수의 가용존에 유사한 리소스를 배치하여 하나의 가용존에 문제가 발생해도 서비스에 장애가 생기지 않도록 설계하는 것이 가능합니다. AWS에서는 리전 당 2개 이상의 가용존을 제공하며, 2개 이상의 가용존(서브넷)을 전제로 네트워크를 설계하는 것을 권장합니다.

서브넷을 만든다고 추가 비용이 발생하지는 않습니다.

이제 EC2 인스턴스를 생성합시다. 네트워크 설정에서 생성한 VPC를 설정하고 서브넷도 방금 생성한 2개 중 하나를 선택합니다. 이 인스턴스에 외부에서 접속을 하려면 `Auto-assign Public IP`를 Enable로 설정합니다.

나머지는 기본값으로 설정하고 인스턴스를 생성합니다. 생성된 인스턴스의 Public IP를 통해 접속해보면 실패합니다.

아마존 공식문서를 확인해보면 다음과 같이 설명합니다.

> VPC 서브넷의 인스턴스에 대한 인터넷 액세스를 활성화하려면 다음을 수행해야 합니다.
>
> - VPC에 인터넷 게이트웨이를 연결합니다.
> - 서브넷의 라우팅 테이블이 인터넷 게이트웨이를 가리키는지 확인합니다.
> - 서브넷의 인스턴스에 전역적으로 고유한 IP 주소(퍼블릭 IPv4 주소, 탄력적 IP 주소 또는 IPv6 주소)가 있는지 확인합니다.
> - 네트워크 액세스 제어 및 보안 그룹 규칙에서 적절한 트래픽이 인스턴스로, 그리고 인스턴스에서 흐르도록 허용되는지 확인합니다.

이 네 가지 조건을 모두 만족해야 인스턴에서 인터넷 접근이 가능하고, 외부에서 접근하는 것도 가능합니다. 네 가지 조건 중 3, 4번째 항목은 이미 충족합니다.

1, 2번째 항목을 해결해봅시다.

## 세 번째 스탭: 인터넷 게이트웨이 만들기

첫 번째 조건부터 확인해봅시다.

> - VPC에 인터넷 게이트웨이를 연결합니다.

좌측 사이드바의 Internet Gateways를 선택합니다. 그리고 Create internet gateway 버튼을 클릭합니다.

설정해야할 값은 이름 하나 입니다. 지정하지 않고 생성도 가능합니다.

처음 생성하면 Detached 상태입니다. Actions 버튼을 클릭하여 Attach to VPC 항목을 선택하고, New Default VPC와 연결합니다.

첫 번째 조건을 처리했습니다. 이제 남은 것은 두 번째 조건입니다.

> - 서브넷의 라우팅 테이블이 인터넷 게이트웨이를 가리키는지 확인합니다.

좌측 사이드바의 Route Tables 에서 서브넷에 연결된 라우트 테이블을 선택하고 하단의 Routes 탭을 클릭합니다.

현재 VPC 내부 연결을 위한 규칙만 설정되어 있습니다.

Edit Routes -> Add Route를 클릭합니다.

Destination 0.0.0.0/0, Target은 인터넷 게이트웨이의 ID를 선택하고 저장합니다.

라우트 규칙은 위에서부터 차례대로 적용됩니다. 첫 번째 규칙은 VPC CIDR 범위의 접근을 VPC 내부로 라우트하는 규칙입니다. 두 번째 규칙은 그 이외의 모든 IP 접근을 인터넷 게이트웨이로 라우트하는 규칙입니다.

여기까지 설정하면 SSH로 EC2에 접속할 수 있습니다.
