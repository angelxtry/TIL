# 04. Django에서의 STATIC 파일 관리

* django는 One Project, Multi App 구조
* 한 App을 위한 static 파일을 app/static/app 경로에 둔다.
* 프로젝트 전반적으로 사용되는 static 파일을 settings.STATICFILE_DIR에서 참조하는 경로에 둔다.
```py
# proj/settings.py
STATIC_URL = '/static/' # Static 파일 요청에 대한 URL Prefix
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, 'proj', 'static'),
]
```

## Django에서의 STATIC 파일 서빙

* myproj/static/main.css => http://localhost:8000/static/main.css 
* myproj/static/jquery/jquery-2.2.4.min.js => http://localhost:8000/static/jquery/
jquery-2.2.4.min.js
* myproj/static/bootstrap/3.3.7/css/bootstrap.min.css => http://localhost:8000/static/
bootstrap/3.3.7/css/bootstrap.min.css
* blog/static/blog/style.css => http://localhost:8000/static/blog/style.css 경로로 접근 가능
* blog/static/blog/blog.js => http://localhost:8000/static/blog/blog.js 경로로 접근 가능
* shop/static/shop/shop.js => http://localhost:8000/static/shop/shop.js 경로로 접근 가능

* URL을 통해 STATIC 파일이 저장된 파일시스템에 직접 접근하는 것이 아니라,
* 지정 이름의 STATIC 파일을 Django의 StaticFiles Finder에서 찾아 그 내용을 읽어서 응답

## 브라우저 캐시
* 브라우저 캐시 기간을 설정해주면 그 기간 동안은 웹브라우저가 해당 파일을 다시 다운받지 않고 캐싱된 내용을 사용한다.
* 트래픽이 줄어들고 속도도 빨라진다.

* Expires header: 만료일시를 지정
* 응답 내에 'max-age', 's-max-age' directive를 지닌 Cache-Control header가 존재할 경우, Expires header는 무시된다.

* 개발 중에 CSS 파일이 변경되었을 때 브라우저 캐시 때문에 적용되지 않는 것 처럼 보일 수 있다.
* 해결방법
    1. 캐싱이 만료될 때까지 기다린다.
    2. 브라우저 설정에서 캐싱된 내용을 삭제한다.
    3. 크롬 브라우저에서는 강력 새로고침을 수행한다.
        * `Ctrl+Shift+R`, `Command+Shift+R`
    4. 해당 STATIC 리소스의 URL을 변경한다.

## 클라이언트측 캐싱과 빠른 업데이트를 하려면
* 리소스의 URL 변경하여 컨텐츠가 변경될 때마다 사용자가 새 응답을 다운로드하도록 한다.

1. GET인자 붙이기: 실제 파일명은 변경하지 않고, 브라우저가 인지하는 URL만 변경
    * 개발시에 유용하다.
    * 버전을 숫자로 추가
        * http://localhost:8000/static/main.css?v=1
    * 버전을 날짜로 추가
        * http://localhost:8000/static/main.css?v=20181018
    * 더미로 현재 시각의 timestamp를 추가.
        * http://localhost:8000/static/main.css?_=1503808011

2. 파일명 변경하기
    * 서비스 배포 시에 유용하다.
    * 번거롭다?

## 커스텀 템플릿 태그를 통해 STATIC URL에 더미 GET인자 붙이기
* 경로 app/tmeplatetags/static_tags.py

```py
import time
from django import template
from django.conf import settings
from django.templatetags.static import StaticNode

register = template.Library()

class VersioningStaticNode(StaticNode):
    def url(self, context):
        url = super().url(context)
        if settings.DEBUG:
            t = str(int(time.time()))
            if '?' not in url:
                url += '?_=' + t
            else:
                url += '&_=' + t
            return url

@register.tag('static_t')
def static_t(parser, token):
    return VersioningStaticNode.handle_token(parser, token)
```

* blog/templatetags 디렉토리 생성
* blog/templatetags/__init__.py 파일 생성
* blog/tmeplatetags/static_tags.py
