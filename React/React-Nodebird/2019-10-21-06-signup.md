# react node bird (5-8 ~ )

## signup api

`routes/user.js`

```js
const express = require("express");
const bcrypt = require("bcrypt");
const { User } = require("../models");

const router = express.Router();

// POST /api/user íšŒì›ê°€ì…
router.post("/", async (req, res) => {
  try {
    const { userId, nickname, password } = req.body;
    const exUser = await User.findOne({ where: { userId } });
    if (exUser) {
      return res.status(403).send("Already used.");
    } else {
      const hashedPassword = await bcrypt.hash(password, 10);
      const newUser = await User.create({
        userId,
        nickname,
        password: hashedPassword
      });
      console.log(newUser);
      return res.status(200).json(newUser);
    }
  } catch (error) {
    console.error(error);
    // ì—ëŸ¬ ì²˜ë¦¬ë¥¼ ì—¬ê¸°ì„œ
    return next(error);
  }
});

module.exports = router;

```

signupì€ ìì£¼ í–ˆë”ë‹ˆ ì´ì œ ì™¸ì›Œì„œ ì¹  ìˆ˜ ìˆì„ ì •ë„ë‹¤.

ì—ëŸ¬ì½”ë“œë¥¼ ê¸°ì–µí•´ë‘ì.

ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìœ ì €ì¼ ê²½ìš° 403ì´ë‹¤.

`index.js`

```js
const express = require('express');
const morgan = require('morgan');
const cors = require('cors');

const db = require('./models');
const userAPIRouter = require('./routes/user');
const postAPIRouter = require('./routes/post');
const postsAPIRouter = require('./routes/posts');

const app = express();
db.sequelize.sync();

app.use(morgan('dev'));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(cors());

app.use('/api/user', userAPIRouter);
app.use('/api/post', postAPIRouter);
app.use('/api/posts', postsAPIRouter);

app.listen(3065, () => {
  console.log(`http://localhost:3065`);
});

```

clientì™€ serverê°€ ë‹¤ë¥¼ ê²½ìš° corsë¥¼ ì£¼ì˜í•˜ì.

## ë¡œê·¸ì¸ì„ ìœ„í•œ ë¯¸ë“¤ì›¨ì–´

cookie-parser, express-session, dotenvë¥¼ ì‚¬ìš©í–ˆë‹¤.

5-10 ì§„í–‰ ì¤‘

## passport

ë¡œê·¸ì¸ì„ ìœ„í•´ passportë¥¼ ì‚¬ìš©í•˜ê¸°ë¡œ í•œë‹¤.

ì¼ë‹¨ index.jsì— passportë¥¼ ë“±ë¡í•˜ì.

```js
const express = require('express');
const morgan = require('morgan');
const cors = require('cors');
const cookieParser = require('cookie-parser');
const session = require('express-session');
const dotenv = require('dotenv');
const passport = require('passport');

const db = require('./models');
const userAPIRouter = require('./routes/user');
const postAPIRouter = require('./routes/post');
const postsAPIRouter = require('./routes/posts');

dotenv.config();

const app = express();
db.sequelize.sync();

app.use(morgan('dev'));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(cors());
app.use(cookieParser(process.env.COOKIE_SECRET));
// httpOnly: Javascriptê°€ cookieì— ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤.
// secure: https
app.use(
  session({
    resave: false,
    saveUninitialized: false,
    secret: process.env.COOKIE_SECRET,
    cookie: {
      httpOnly: true,
      secure: false,
    },
  }),
);
app.use(passport.initialize());
// passport.sessionì€ express-session ì•„ë˜ì— ì ì–´ì•¼ í•œë‹¤.
app.use(passport.session());

app.use('/api/user', userAPIRouter);
app.use('/api/post', postAPIRouter);
app.use('/api/posts', postsAPIRouter);

app.listen(3065, () => {
  console.log(`http://localhost:3065`);
});

```

index.jsì—ì„œëŠ” passportë¥¼ requireë¡œ ë¶ˆëŸ¬ì˜¤ê³ 

```js
app.use(passport.initialize());
app.use(passport.session());
```

ì´ë ‡ê²Œ ë‘ ë¼ì¸ë§Œ ì¶”ê°€í•˜ë©´ ëœë‹¤.

 passport.sessionì€ expressì˜ sessionì„ ì´ìš©í•˜ê¸° ë•Œë¬¸ì— express-session ì•„ë˜ì— ì ì–´ì•¼ í•œë‹¤.

`passport/index.js`

```js
const passport = reqiure('passport');
const { User } = require('../models');

module.exports = () => {
  passport.serializeUser((user, done) => {
    return done(null, user.id);
  });

  passport.deserializeUser(async (id, done) => {
    try {
      const user = await User.findOne({ where: { id } });
      return done(null, user);
    } catch (error) {
      console.error(error);
      done(erroe);
    }
  });
};

```

ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ê²ƒì€ serializeì™€ deserializeë‹¤.

ì„œë²„ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ëª¨ë‘ ì„¸ì…˜ì— ì €ì¥í•˜ê³  ìˆìœ¼ë©´ ê¸ˆìƒˆ ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•´ì§„ë‹¤.

ê·¸ë˜ì„œ ì„œë²„ì—ì„œëŠ” user.idì™€ cookieë§Œë“¤ ê¸°ì–µí•˜ê³  ìˆë‹¤.

í´ë¼ì´ì–¸íŠ¸ì—ì„œ cookieê°€ ë“¤ì–´ì˜¤ë©´ í•´ë‹¹ cookieì— ë§ëŠ” user.idë¥¼ ì°¾ê³  user ì •ë³´ë¥¼ ì‚¬ìš©í•  ë•Œ user.idë¡œ DBë¥¼ ì¡°íšŒí•´ì„œ user ì •ë³´ë¥¼ í™•ì¸í•œë‹¤.

`deserializeUser`ì—ì„œ `return done(null, user);` ê°€ ì‹¤í–‰ë  ë•Œ user ì •ë³´ëŠ” `req.user`ì— ì €ì¥ëœë‹¤.

## passport-local

`passport/local.js`

```js
const passport = require('passport');
const { Strategy: LocalStrategy } = require('passport-local');
const bcrypt = require('bcrypt');
const { User } = require('../models');

module.exports = () => {
  passport.use(new LocalStrategy({

  }, async (userId, password, done) => {

  }));
}

```

LocalStrategyì˜ ê¸°ë³¸ ê³¨ê²©ì´ë‹¤.

ì—¬ê¸°ì— í•˜ë‚˜ì”© ì‚´ì„ ë¶™ì—¬ ë‚˜ê°„ë‹¤.

```js
const passport = require('passport');
const { Strategy: LocalStrategy } = require('passport-local');
const bcrypt = require('bcrypt');
const { User } = require('../models');

module.exports = () => {
  passport.use(new LocalStrategy({
    usernameField: userId,
    passwordField: password
  }, async (userId, password, done) => {

  }));
}

```

`userId`, `password`ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ë‹¬ë˜ëŠ” ê°’ì´ë‹¤.

async í•¨ìˆ˜ ë‚´ì—ì„œ ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤.

```js
const passport = require('passport');
const { Strategy: LocalStrategy } = require('passport-local');
const bcrypt = require('bcrypt');
const { User } = require('../models');

module.exports = () => {
  passport.use(
    new LocalStrategy(
      {
        usernameField: userId,
        passwordField: password,
      },
      async (userId, password, done) => {
        try {
          const user = User.findOne({ where: { userId } });
          if (!user) {
            return done(null, false, { reason: 'Not exist user.' });
          }
        } catch (error) {
          console.error(error);
          return done(error);
        }
      },
    ),
  );
};

```

ì¼ë‹¨ async í•¨ìˆ˜ ë‚´ë¶€ë¥¼ try, catchë¡œ ê°ì‹¼ë‹¤.

ì—ëŸ¬ê°€ ë°œìƒí•˜ì—¬ catchê°€ í˜¸ì¶œë˜ë©´ console.errorë¡œ ì¶œë ¥í•˜ê³  done(error)ë¥¼ ë³´ë‚´ê³  ëë‚¸ë‹¤.

tryë¬¸ì´ ì‹¤í–‰ë˜ë©´ DBì— í•´ë‹¹ ì‚¬ìš©ìì˜ ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.

ì •ë³´ê°€ ì—†ë‹¤ë©´ `done(null, false ...)`ì„ ì‹¤í–‰í•˜ê³  ëë‚¸ë‹¤.

ì—¬ê¸°ì„œ ìì£¼ ì‚¬ìš©ë˜ëŠ” doneì€ ì²« ë²ˆì§¸ ì¸ìë¡œ ì„œë²„ì˜ ì—ëŸ¬ë¥¼ ì „ë‹¬í•œë‹¤.

nullì¼ ê²½ìš° ì„œë²„ ì—ëŸ¬ëŠ” ì—†ë‹¤ëŠ” ì˜ë¯¸ë‹¤.

ë‘ ë²ˆì§¸ ì¸ìëŠ” ì‚¬ìš©ì ì •ë³´ë¥¼ ì „ë‹¬í•˜ê±°ë‚˜ ì—†ì„ ê²½ìš° falseë¥¼ ì „ë‹¬í•œë‹¤.

ì„¸ ë²ˆì§¸ ì¸ìë¥¼ ì£¼ë¡œ ë¡œì§ ì—ëŸ¬ë¥¼ ì „ë‹¬í•  ë•Œ ì‚¬ìš©ëœë‹¤.

ì •ìƒì ìœ¼ë¡œ DBë¥¼ ê²€ìƒ‰í–ˆìœ¼ë‚˜ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì„ ê²½ìš° `done(null, false, {[ì´ìœ ]})`ì™€ ê°™ì€ ëª¨ì–‘ì´ ëœë‹¤.

```js
const passport = require('passport');
const { Strategy: LocalStrategy } = require('passport-local');
const bcrypt = require('bcrypt');
const { User } = require('../models');

module.exports = () => {
  passport.use(
    new LocalStrategy(
      {
        usernameField: userId,
        passwordField: password,
      },
      async (userId, password, done) => {
        try {
          const user = User.findOne({ where: { userId } });
          if (!user) {
            return done(null, false, { reason: 'Not exist user.' });
          }
          const result = await bcrypt.compare(password, user.password);
          if (result) {
            return done(null, user);
          }
          return done(null, false, { reason: 'Password is incorrent.' });
        } catch (error) {
          console.error(error);
          return done(error);
        }
      },
    ),
  );
};

```

userê°€ ì¡´ì¬í•œë‹¤ë©´ passwordë¥¼ ë¹„êµí•œë‹¤.

passwordê°€ ì¼ì¹˜í•œë‹¤ë©´ `return done(null, user);`ë¥¼ ìˆ˜í–‰í•œë‹¤.

passwordê°€ í‹€ë¦¬ë‹¤ë©´ `return done(null, false, {[ì´ìœ ]});`ë¥¼ ì‹¤í–‰í•œë‹¤.

`passport/local.js`ê°€ ì™„ì„±ëë‹¤ë©´ ë‹¤ì‹œ `passport/index.js`ì—ì„œ LocalStrategyë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ë“±ë¡í•œë‹¤.

```js
const passport = reqiure('passport');
const local = require('./local');

const { User } = require('../models');

module.exports = () => {
  passport.serializeUser((user, done) => {
    return done(null, user.id);
  });

  passport.deserializeUser(async (id, done) => {
    try {
      const user = await User.findOne({ where: { id } });
      return done(null, user);
    } catch (error) {
      console.error(error);
      done(erroe);
    }
  });

  local();
};

```

ê·¸ë¦¬ê³  expressì—ì„œ passportë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ index.jsì— ë“±ë¡í•œë‹¤.

```js
const express = require('express');
const morgan = require('morgan');
const cors = require('cors');
const cookieParser = require('cookie-parser');
const session = require('express-session');
const dotenv = require('dotenv');
const passport = require('passport');

const passportConfig = require('./passport');
const db = require('./models');
const userAPIRouter = require('./routes/user');
const postAPIRouter = require('./routes/post');
const postsAPIRouter = require('./routes/posts');

dotenv.config();

const app = express();
db.sequelize.sync();
passportConfig();

app.use(morgan('dev'));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(cors());
app.use(cookieParser(process.env.COOKIE_SECRET));
// httpOnly: Javascriptê°€ cookieì— ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤.
// secure: https
app.use(
  session({
    resave: false,
    saveUninitialized: false,
    secret: process.env.COOKIE_SECRET,
    cookie: {
      httpOnly: true,
      secure: false,
    },
  }),
);
app.use(passport.initialize());
// passport.sessionì€ express-session ì•„ë˜ì— ì ì–´ì•¼ í•œë‹¤.
app.use(passport.session());

app.use('/api/user', userAPIRouter);
app.use('/api/post', postAPIRouter);
app.use('/api/posts', postsAPIRouter);

app.listen(3065, () => {
  console.log(`http://localhost:3065`);
});

```

`passportConfig`ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ `./passport.js`ë¥¼ ë¡œë“œí–ˆê³ , `passportConfig()`ë¡œ ì‹¤í–‰í–ˆë‹¤.

ì´ë ‡ê²Œ ë§Œë“  passportëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‚¬ìš©ì ë¡œê·¸ì¸ ìš”ì²­ì´ ì˜¤ë©´ ì‹¤í–‰ëœë‹¤.

ë”°ë¼ì„œ ë¡œê·¸ì¸ ìš”ì²­ì„ ì²˜ë¦¬í•  routerë¥¼ ìƒì„±í•´ì•¼ í•œë‹¤.

`routes/user.js`ì— ë¡œê·¸ì¸ ë¡œì§ì„ ì¶”ê°€í•œë‹¤.

```js
const express = require('express');
const bcrypt = require('bcrypt');
const passport = require('passport');
const { User } = require('../models');

const router = express.Router();

// POST /api/user/login ë¡œê·¸ì¸ ìš”ì²­
router.post('/login', (req, res, next) => {
  passport.authenticate('local', (error, user, info) => {

  })(req, res, next);
});

module.exports = router;

```

ë¡œê·¸ì¸ ìš”ì²­ì´ ì˜¤ë©´ `passport.authenticate()` í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•œë‹¤.

ì²« ë²ˆì§¸ ì¸ìëŠ” ì–´ë–¤ ì „ëµì„ ì„ íƒí•  ê²ƒì¸ì§€ë¥¼ ê²°ì •í•œë‹¤.

ë‘ ë²ˆì§¸ ì¸ìëŠ” passportì—ì„œ ì‚¬ìš©í–ˆë˜ doneì´ë‹¤.

```js
// POST /api/user/login ë¡œê·¸ì¸ ìš”ì²­
router.post('/login', (req, res, next) => {
  passport.authenticate('local', (error, user, info) => {
    if (error) {
      return next(error);
    }
    if (info) {
      return res.status(401).send(info.reason);
    }
    return req.login(user, (loginError) => {
      if (loginError) {
        return next(loginError);
      }
      const filteredUser = Object.assign({}, user);
      delete filteredUser.password;
      res.status(200).json(filteredUser);
    })
  })(req, res, next);
});
```

error ê°€ ìˆë‹¤ë©´ nextë¡œ ë³´ë‚´ê³  ë

infoê°€ ìˆë‹¤ë©´ í´ë¼ì´ì–¸íŠ¸ì— ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ë

ì˜¤ë¥˜ê°€ ì—†ê³  user ì •ë³´ë¥¼ í™•ì¸í–ˆë‹¤ë©´ password ì •ë³´ë¥¼ ì‚­ì œí•˜ê³  user ì •ë³´ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë³´ë‚¸ë‹¤.

## passport ì¬ì •ë¦¬

í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¡œê·¸ì¸ ìš”ì²­ì´ ì˜¤ë©´ routerì— ë„ì°©í•œë‹¤.

routerì—ì„œëŠ” passportë¡œ í•´ë‹¹ ë°ì´í„°ë¥¼ ë³´ë‚´ê³  ì ì ˆí•œ ì „ëµì„ í†µí•´ ê³„ì • ì •ë³´ë¥¼ í™•ì¸í•œë‹¤.

ê³„ì • ì •ë³´ê°€ ì˜ í™•ì¸ëë‹¤ë©´ í´ë¼ì´ì–¸íŠ¸ë¡œ ê³„ì • ì •ë³´ë¥¼ ë³´ë‚´ì¤€ë‹¤.

ì´ ì‹œì ì—ì„œ `req.login`ì„ í•  ë•Œ `serializeUser`ê°€ ì‹¤í–‰ëœë‹¤.

`serializeUser`ëŠ” ì„œë²„ìª½ì— idì™€ cookieë§Œì„ ì €ì¥í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.

ì´í›„ì— í´ë¼ì´ì–¸íŠ¸ì—ì„œ cookieë¥¼ ë³´ë‚´ì£¼ë©´ sessionì—ì„œ idë¥¼ í™•ì¸í•˜ê³  deserializeUserì—ì„œ idë¡œ ê³„ì •ì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸í•  ìˆ˜ ìˆê²Œ ëœë‹¤.

deserializeUserëŠ” ê³„ì • ì •ë³´ë¥¼ req.userì— ë„£ëŠ”ë‹¤.

deserializeUserëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œë§ˆë‹¤ ì‹¤í–‰ëœë‹¤.

DBë¥¼ ì¡°íšŒí•˜ëŠ” ë¡œì§ì´ ë“¤ì–´ìˆê¸° ë•Œë¬¸ì— ìºì‹±í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì´ë‹¤.

## í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸ì¸ í™•ì¸

ì´ì œ ë”ë¯¸ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ë˜ ê³¼ê±°ëŠ” ìŠì–´ë²„ë¦¬ê³  ë¡œê·¸ì¸ ê³¼ì •ì„ í†µí•´ ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì.

`sagas/user.js` íŒŒì¼ì„ ìˆ˜ì •í•˜ì.

```js
import {
  all,
  call,
  fork,
  takeLatest,
  takeEvery,
  put,
} from 'redux-saga/effects';
import axios from 'axios';
import {
  LOG_IN_REQUEST,
  LOG_IN_SUCCESS,
  LOG_IN_FAILURE,
  SIGN_UP_REQUEST,
  SIGN_UP_SUCCESS,
  SIGN_UP_FAILURE,
} from '../reducers/user';

axios.defaults.baseURL = 'http://localhost:3065/api';

function loginAPI(loginData) {
  return axios.post('/user/login', loginData);
}

function* login(action) {
  try {
    const result = yield call(loginAPI, action.payload);
    console.log(result);
    yield put({
      // putì€ dispatchì™€ ë™ì¼
      type: LOG_IN_SUCCESS,
      payload: result.data,
    });
  } catch (error) {
    console.error(error);
    yield put({
      type: LOG_IN_FAILURE,
    });
  }
}

function* watchLogin() {
  yield takeEvery(LOG_IN_REQUEST, login);
}

export default function* userSaga() {
  yield all([fork(watchLogin), fork(watchSignUp)]);
}

```

axiosë¡œ ì„œë²„ì— ìš”ì²­ì„ í•˜ë©´ ì‚½ì§ˆí•˜ì§€ ì•Šì€ ì´ìƒ ê²°ê³¼ê°€ ëŒì•„ì˜¨ë‹¤.

ë°©ê¸ˆ ì „ì— ê²°ê³¼ê°€ ë‚˜ì˜¤ëŠ” ê²ƒì„ í™•ì¸í–ˆìœ¼ë‹ˆ axiosì˜ ê²°ê³¼ë¥¼ return í•œë‹¤.

ê·¸ë¦¬ê³  `LOG_IN_SUCCESS`ë¥¼ put í•  ë•Œ ê²°ê³¼ë¥¼ í•¨ê»˜ ì „ë‹¬í•œë‹¤.

ì´ ê²°ê³¼ëŠ” reducerë¡œ ì „ë‹¬ëœë‹¤.

## ë³´ì•ˆ, https ê´€ë ¨

Chromeì˜ Network íƒ­ì—ì„œ login ë¶€ë¶„ì„ ë³´ë©´ ë¡œê·¸ì¸ í•œ ì‚¬ìš©ìì˜ ê³„ì •ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.

POST ë°©ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³´ë‚´ë„ ê²°êµ­ í™•ì¸ê°€ëŠ¥í•˜ë‹¤.

ì´ ë¶€ë¶„ì„ ë§‰ê¸° ìœ„í•´ httpsê°€ í•„ìš”í•˜ë‹¤.

## cookie êµí™˜

ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ ê°„ì— cookieë¥¼ êµí™˜í•˜ê¸° ìœ„í•´ ì¶”ê°€ ì‘ì—…ì´ í•„ìš”í•˜ë‹¤.

`sagas/user.js`

```js
function loginAPI(loginData) {
  // ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ëŠ” ë¶€ë¶„
  return axios.post('/user/login', loginData, {
    withCredentials: true
  });
}
```

ì„œë²„ì˜ `index.js`

```js
app.use(
  cors({
    origin: true,
    credentials: true,
  }),
);
```

ì´ì œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë‹¤ì‹œ ë¡œê·¸ì¸ì„ í•´ë³´ë©´ ë¸Œë¼ìš°ì €ì—ì„œ ì¿ í‚¤ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ë³„ë„ì˜ ì¡°ì¹˜ê°€ ì—†ì—ˆë‹¤ë©´ `connect.sid`ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ cookieê°€ ìƒê¸´ë‹¤.

ë³´ì•ˆìƒ ì´ ì´ë¦„ë„ ë³€ê²½í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

```js
app.use(
  session({
    resave: false,
    saveUninitialized: false,
    secret: process.env.COOKIE_SECRET,
    cookie: {
      httpOnly: true,
      secure: false,
    },
    name: 'rnban'
  }),
);
```

sessionì—ì„œ nameì´ë¼ëŠ” ì˜µì…˜ì„ ì§€ì •í•˜ë©´ cookieì˜ ì´ë¦„ì´ ëœë‹¤.

## ë¡œê·¸ì¸ ì¶”ê°€

`routes/user.js`

```js
// POST /api/user/login ë¡œê·¸ì¸ ìš”ì²­
router.post('/login', (req, res, next) => {
  passport.authenticate('local', (error, user, info) => {
    if (error) {
      return next(error);
    }
    if (info) {
      return res.status(401).send(info.reason);
    }
    return req.login(user, async (loginError) => {
      try {
        if (loginError) {
          return next(loginError);
        }
        const fullUser = await User.findOne({
          where: { id: user.id },
          include: [
            { model: Post, as: 'Posts', attributes: ['id'] },
            { model: User, as: 'Followings', attributes: ['id'] },
            { model: User, as: 'Followers', attributes: ['id'] },
          ],
          attributes: ['id', 'nickname', 'userId'],
        });
        console.log(fullUser);
        res.status(200).json(fullUser);
      } catch (error) {
        next(error);
      }
    });
  })(req, res, next);
});

```

ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ë©´ ë‹¤ì‹œ í•œë²ˆ queryë¥¼ ì‹¤í–‰í•˜ì—¬ í•´ë‹¹ ì‚¬ìš©ìì˜ ì¶”ê°€ ì •ë³´ë¥¼ select í•œ í›„ í´ë¼ì´ì–¸íŠ¸ì— ì •ë³´ë¥¼ ëŒë ¤ì¤€ë‹¤.
