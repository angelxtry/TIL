# react node bird (4-10 ~ )

## redux ë¡œê·¸ì¸ êµ¬í˜„

`reducer/user.js`ì—ì„œ `initialState`ë¥¼ ìˆ˜ì •í•œë‹¤.

```js
const initialState = {
  isLoggedIn: false,
  isLoggingOut: false,
  isLoggingIn: false,
  loginErrorReason: '',
  signedUp: false,
  isSigningUp: false,
  signUpErrorReason: '',
  me: null,
  followingList: [],
  followerList: [],
  userInfor: null,
};

```

ê° í•­ëª©ì€ ë‹¤ìŒê³¼ ê°™ì€ ì˜ë¯¸ë‹¤.

```js
isLoggedIn: ë¡œê·¸ì¸ ì—¬ë¶€
isLoggingOut: ë¡œê·¸ì•„ì›ƒ ì‹œë„ ì¤‘
isLoggingIn: ë¡œê·¸ì¸ ì‹œë„ ì¤‘
loginErrorReason: ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‚¬ìœ 
signedUp: íšŒì›ê°€ìž… ì„±ê³µ
isSigningUp: íšŒì›ê°€ìž… ì‹œë„ ì¤‘
signUpErrorReason: íšŒì›ê°€ìž… ì‹¤íŒ¨ ì‚¬ìœ 
me: null,
followingList: following list
followerList: follower list
userInfor: ë‚¨ì˜ ì •ë³´
```

`components/LoginForm.js`ë¥¼ ìˆ˜ì •í•œë‹¤.

```js
import React, { useCallback } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import Link from 'next/link';
import { Form, Input, Button } from 'antd';

import useInput from './useInput';
import { LOG_IN_REQUEST } from '../reducers/user';

const LoginForm = () => {
  const [id, onChangeId] = useInput('');
  const [password, onChangePassword] = useInput('');
  const dispatch = useDispatch();
  const { isLoggingIn } = useSelector(state => state.user);
  const onSubmit = useCallback(
    (e) => {
      e.preventDefault();
      dispatch({
        type: LOG_IN_REQUEST,
        payload: {
          id, password
        }
      });
    },
    [id, password],
  );

  return (
    <Form onSubmit={onSubmit} style={{ padding: '10px' }}>
      <div>
        <label htmlFor="user-id">ID</label>
        <br />
        <Input name="user-id" required value={id} onChange={onChangeId} />
      </div>
      <div>
        <label htmlFor="user-password">Password</label>
        <br />
        <Input
          name="user-password"
          required
          type="password"
          value={password}
          onChange={onChangePassword}
        />
      </div>
      <div style={{ marginTop: '10px' }}>
        <Button type="primary" htmlType="submit" loading={isLoggingIn}>
          Login
        </Button>
        <Link href="/signup">
          <Button>Signup</Button>
        </Link>
      </div>
    </Form>
  );
};

export default LoginForm;

```

`reducers/user.js`ì—ì„œ ì„ ì–¸í•œ typeì„ ë¶ˆëŸ¬ì™€ ì‚¬ìš©í•œë‹¤.

`LOG_IN_REQUEST` typeì„ `onSubmit` í•¨ìˆ˜ì—ì„œ ì‚¬ìš©í•œë‹¤.

```js
const onSubmit = useCallback(
  (e) => {
    e.preventDefault();
    dispatch({
      type: LOG_IN_REQUEST,
      payload: {
        id, password
      }
    });
  },
  [id, password],
);
```

`useSelector`ë¥¼ ì´ìš©í•˜ì—¬ `isLoggingIn`ì„ ê°€ì ¸ì™€, ë¡œê·¸ì¸ ì¤‘ì´ë¼ëŠ” ì•„ì´ì½˜ì„ í‘œì‹œí•œë‹¤.

```js
const { isLoggingIn } = useSelector(state => state.user);
...
<div style={{ marginTop: '10px' }}>
  <Button type="primary" htmlType="submit" loading={isLoggingIn}>
    Login
  </Button>
  <Link href="/signup">
    <Button>Signup</Button>
  </Link>
</div>
```

`sagas/user.js`

```js
function loginAPI() {
  // ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ëŠ” ë¶€ë¶„
  axios.post('/login');
}

function* login() {
  try {
    // yield call(loginAPI);
    delay(2000);
    yield put({
      // putì€ dispatchì™€ ë™ì¼
      type: LOG_IN_SUCCESS,
    });
  } catch (error) {
    console.error(error);
    yield put({
      type: LOG_IN_FAILURE,
    });
  }
}

function* watchLogin() {
  yield takeEvery(LOG_IN_REQUEST, login);
}
```

ì•„ì§ ì„œë²„ìª½ì— êµ¬í˜„ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ `yield call(loginAPI)` ëŒ€ì‹  `delay(2000)`ë¥¼ ì´ìš©í•œë‹¤.

`reducers/user.js`ì—ì„œ reducerì— login ê´€ë ¨ typeì„ ì •ì˜í•œë‹¤.

```js
const reducer = (state = initialState, action) => {
  switch (action.type) {
    case LOG_IN_REQUEST: {
      return {
        ...state,
        isLoggingIn: true,
        loginErrorReason: '',
      };
    }
    case LOG_IN_SUCCESS: {
      return {
        ...state,
        isLoggedIn: true,
        isLoggingIn: false,
        me: dummyUser,
      };
    }
    case LOG_IN_FAILURE: {
      return {
        ...state,
        isLoggedIn: false,
        isLoggingIn: false,
        loginErrorReason: action.error,
        me: null
      }
    }
...
```

## sign up

signupì€ reducerì— ë‹¤ìŒê³¼ ê°™ì´ ì •ì˜ë˜ì–´ ìžˆë‹¤.

```js
const reducer = (state = initialState, action) => {
  switch (action.type) {
    ...
    case SIGN_UP_REQUEST: {
      return {
        ...state,
        isSigningUp: true,
        isSignedUp: false,
        signUpErrorReason: '',
      };
    }
    case SIGN_UP_SUCCESS: {
      return {
        ...state,
        isSigningUp: false,
        isSignedUp: true,
      };
    }
    case SIGN_UP_FAILURE: {
      return {
        ...state,
        isSigningUp: false,
        signUpErrorReason: action.error,
      };
    }
    default: {
      return state;
    }
  }
};

```

`sagas/user.js` íŒŒì¼

```js
function signUpAPI() {
  // ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ëŠ” ë¶€ë¶„
}

function* signUp() {
  try {
    // yield call(signUpAPI);
    yield delay(2000);
    throw new Error('ì—ëŸ¬ ì—ëŸ¬ ì—ëŸ¬');
    // yield put({
    //   // putì€ dispatchì™€ ë™ì¼
    //   type: SIGN_UP_SUCCESS,
    // });
  } catch (error) {
    console.error(error);
    yield put({
      type: SIGN_UP_FAILURE,
      error: error,
    });
  }
}
function* watchSignUp() {
  yield takeLatest(SIGN_UP_REQUEST, signUp);
}

```

loginê³¼ ë™ì¼í•œ êµ¬ì¡°ë‹¤.

signupì„ ì‹œë„í•˜ë©´ 2ì´ˆ í›„ì— ì—ëŸ¬ê°€ ë°œìƒí•˜ë„ë¡ ì„¤ì •í•´ë‘ì—ˆë‹¤.

## post ìž‘ì„±

post ìž‘ì„±ë„ login, signupê³¼ ë™ì¼í•˜ë‹¤.

reducerì— í•´ë‹¹ actionì„ ì •ì˜í•˜ê³ (ì—¬ê¸°ì„œëŠ” typeë§Œ ì •ì˜í–ˆë‹¤.) sagaì— ë¹„ë™ê¸° actionì„ ì •ì˜í•œë‹¤.

ê·¸ë¦¬ê³  í•´ë‹¹ í™”ë©´ì—ì„œ í•´ë‹¹ ê¸°ëŠ¥ì„ êµ¬í˜„í•œë‹¤.

ì¼ë‹¨ `reducers/post.js` íŒŒì¼ì„ ì‚´íŽ´ë³´ìž.

```js
const reducer = (state = initialState, action) => {
  switch (action.type) {
    case ADD_POST_REQUEST: {
      return {
        ...state,
        isAddingPost: true,
        addPostErrorReason: '',
        postAdded: false,
      };
    }
    case ADD_POST_SUCCESS: {
      return {
        ...state,
        isAddingPost: false,
        mainPosts: [dummyPost, ...state.mainPosts],
        postAdded: true,
      };
    }
    case ADD_POST_FAILURE: {
      return {
        ...state,
        isAddingPost: false,
        addPostErrorReason: action.error,
      };
    }
    default: {
      return state;
    }
  }
};

export default reducer;
```

REQUEST, SUCCESS, FAILURE êµ¬ì¡°ë‹¤.

login, signupê³¼ ë‹¬ë¦¬ postAddedë¼ëŠ” í•­ëª©ì´ ìžˆë‹¤.

Formì—ì„œ "twit"(ìž‘ì„±í•˜ê¸°) ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ input ì°½ì˜ ê¸€ìžë¥¼ ì§€ìš°ê¸° ìœ„í•´ ì„ ì–¸í–ˆë‹¤.

`useEffect`ì—ì„œ ì‚¬ìš©ëœë‹¤.

ë‹¤ìŒìœ¼ë¡œ `sagas/post.js`ë¥¼ ë³´ìž.

```js
import { all, fork, takeLatest, delay, put } from 'redux-saga/effects';

import {
  ADD_POST_REQUEST,
  ADD_POST_SUCCESS,
  ADD_POST_FAILURE,
} from '../reducers/post';

function* addPost() {
  try {
    yield delay(2000);
    yield put({
      type: ADD_POST_SUCCESS,
    });
  } catch (error) {
    yield put({
      type: ADD_POST_FAILURE,
      error,
    });
  }
}

function* watchAddPost() {
  yield takeLatest(ADD_POST_REQUEST, addPost);
}
export default function* postSaga() {
  yield all([fork(watchAddPost)]);
}

```

ì½”ë“œì—ëŠ” ë¹ ì ¸ìžˆì§€ë§Œ `addPostAPI` í•¨ìˆ˜ê°€ ì¶”ê°€ë  ê²ƒì´ë‹¤.

`watchAddPost`ê°€ ìš”ì²­ì„ ëŒ€ê¸°í•˜ê³  ìžˆë‹¤ê°€ ìš”ì²­ì´ ì˜¤ë©´ addPost ì œë„¤ë ˆì´í„°ë¥¼ í˜¸ì¶œí•œë‹¤.

`addPost`ëŠ” `addPostAPI`ë¥¼ í˜¸ì¶œí•˜ê³  ê·¸ ê²°ê³¼ì— ë”°ë¼ typeì„ reducerì— ì „ë‹¬í•œë‹¤.

`components/PostForm.js`

```js
import React, { useState, useCallback, useEffect } from 'react';
import { useSelector, useDispatch } from 'react-redux';
import { Form, Input, Button } from 'antd';
import { ADD_POST_REQUEST } from '../reducers/post';

const PostForm = () => {
  const dispatch = useDispatch();
  const [text, setText] = useState('');
  const { imagePaths, isAddingPost, postAdded} = useSelector((state) => state.post);

  useEffect(() => {
    setText('');
  }, [postAdded === true])

  const onChangeText = useCallback((e) => {
    setText(e.target.value);
  }, []);

  const onSubmitForm = useCallback((e) => {
    e.preventDefault();
    dispatch({
      type: ADD_POST_REQUEST,
      payload: {
        text,
      },
    });
  }, []);

  return (
    <Form
      encType="multipart/form-data"
      style={{ margin: '10px 0 20px' }}
      onSubmit={onSubmitForm}
    >
      <Input.TextArea
        maxLength={140}
        placeholder="ì–´ë–¤ ì‹ ê¸°í•œ ì¼ì´ ìžˆì—ˆë‚˜ìš”?"
        value={text}
        onChange={onChangeText}
      />
      <div>
        <input type="file" multiple hidden />
        <Button>Image Upload</Button>
        <Button
          type="primary"
          style={{ float: 'right' }}
          htmlType="submit"
          loading={isAddingPost}
        >
          twit
        </Button>
      </div>
      <div>
        {imagePaths.map((v) => {
          return (
            <div key={v} style={{ display: 'inline-block' }}>
              <img
                src={'http://localhost:3065' + v}
                style={{ width: '200px' }}
                alt={v}
              />
              <div>
                <Button>Delete</Button>
              </div>
            </div>
          );
        })}
      </div>
    </Form>
  );
};

export default PostForm;

```

ì¼ë¶€ ì½”ë“œë¥¼ ìž˜ë¼ì„œ ì„¤ëª…í•˜ìžë©´

```js
useEffect(() => {
  setText('');
}, [postAdded === true])

```

`postAdded`ê°€ trueì´ë©´ `Input.TextArea`ì—ì„œ ê¸€ì´ ì§€ì›Œì§€ë„ë¡ ìž‘ì„±í–ˆë‹¤.

## loginì‹œ signup íŽ˜ì´ì§€ì—ì„œ root íŽ˜ì´ì§€ë¡œ redirect

```js
useEffect(() => {
  if (me) {
    Router.push('/');
  }
}, [me && me.id]);

```

`pages/signup.js` íŒŒì¼ì— ìœ„ ì½”ë“œë¥¼ ì¶”ê°€í–ˆë‹¤.

ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ me ê°ì²´ì— ë°ì´í„°ê°€ ìž…ë ¥ëœë‹¤. ê·¸ëž˜ì„œ me.idê°€ ìžˆìœ¼ë©´ useEffectê°€ ë™ìž‘í•˜ë„ë¡ ì²˜ë¦¬í•œë‹¤.

íŽ˜ì´ì§€ ì´ë™ì€ next/routerì˜ Routerë¥¼ ì‚¬ìš©í–ˆë‹¤.

dependencyì— me && me.id ê°€ ê¼­ í•„ìš”í•˜ë‹¤.

ê°ì²´ë¥¼ ê²€ì‚¬í•  ë•ŒëŠ” gurad patternì„ ê¼­ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

## Comment êµ¬í˜„

ëŒ“ê¸€ êµ¬í˜„ì´ ë§Œë§Œì¹˜ ì•Šë‹¤.

ë‚´ê°€ ì–´ë µë‹¤ê³  ìƒê°ë˜ëŠ” ë¶€ë¶„ì€ reduxì—ì„œ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ëŠ” ë¶€ë¶„.

UIì—ì„œ í•´ë‹¹ ë¶€ë¶„ì„ êµ¬í˜„í•˜ëŠ” ë¶€ë¶„ì´ë‹¤.

ì—¬ê¸°ë„ ì¼ë‹¨ ì½”ë“œë§Œ ì ì–´ë†“ê³  ë‚˜ì¤‘ì— ë‹¤ì‹œ ë´ì•¼ê² ë‹¤.

`reducers/post.js`

```js
const initialState = {
  mainPosts: [
    {
      id: 1,
      User: {
        id: 1,
        nickname: 'angelx',
      },
      content: 'First tweet',
      img:
        'https://newsimg.hankookilbo.com/2019/04/29/201904291390027161_3.jpg',
      Comments: [],
    },
  ],
  imagePaths: [],
  isAddingPost: false,
  addPostErrorReason: '',
  postAdded: false,
  isAddingComment: false,
  addCommentErrorReason: '',
  commentAdded: false,
};

const dummyPost = {
  id: 2,
  User: {
    id: 1,
    nickname: 'angelx',
  },
  content: 'dummy post contet',
  Comments: [],
};

const dummyComment = {
  id: 1,
  User: {
    id: 1,
    nickname: 'angelx',
  },
  createdAt: new Date(),
  content: 'dummy comment',
};

const reducer = (state = initialState, action) => {
  switch (action.type) {
    case ADD_COMMENT_REQUEST: {
      return {
        ...state,
        isAddingComment: true,
        addCommentErrorReason: '',
        commentAdded: false,
      };
    }
    case ADD_COMMENT_SUCCESS: {
      const postIndex = state.mainPosts.findIndex(
        (v) => v.id === action.payload.postId,
      );
      const post = state.mainPosts[postIndex];
      const Comments = [...post.Comments, dummyComment];
      const mainPosts = [...state.mainPosts];
      mainPosts[postIndex] = { ...post, Comments };
      return {
        ...state,
        isAddingComment: false,
        mainPosts,
        commentAdded: true,
      };
    }
    case ADD_COMMENT_FAILURE: {
      return {
        ...state,
        isAddingComment: false,
        addCommentErrorReason: action.error,
      };
    }
    default: {
      return state;
    }
  }
};

export default reducer;

```

`sagas/post.js`

```js
import { all, fork, takeLatest, delay, put } from 'redux-saga/effects';

import {
  ADD_POST_REQUEST,
  ADD_POST_SUCCESS,
  ADD_POST_FAILURE,
  ADD_COMMENT_REQUEST,
  ADD_COMMENT_SUCCESS,
  ADD_COMMENT_FAILURE,
} from '../reducers/post';

function addPostAPI() {
  // api
}

function* addPost() {
  try {
    yield delay(2000);
    yield put({
      type: ADD_POST_SUCCESS,
    });
  } catch (error) {
    yield put({
      type: ADD_POST_FAILURE,
      error,
    });
  }
}

function* watchAddPost() {
  yield takeLatest(ADD_POST_REQUEST, addPost);
}

function addCommentAPI() {
  // api
}

function* addComment(action) {
  try {
    yield delay(2000);
    yield put({
      type: ADD_COMMENT_SUCCESS,
      payload: {
        postId: action.payload.postId,
      },
    });
  } catch (error) {
    yield put({
      type: ADD_COMMENT_FAILURE,
      error,
    });
  }
}

function* watchAddComment() {
  yield takeLatest(ADD_COMMENT_REQUEST, addComment);
}

export default function* postSaga() {
  yield all([fork(watchAddPost), fork(watchAddComment)]);
}

```;

`componets/PostCard.js`


```js
import React, { useState, useCallback, useEffect } from 'react';
import { useSelector, useDispatch } from 'react-redux';
import PropTypes from 'prop-types';
import { Button, Icon, Card, Avatar, Form, Input, List, Comment } from 'antd';
import { ADD_COMMENT_REQUEST } from '../reducers/post';

const PostCard = ({ post }) => {
  const [commentFormOpend, setCommentFormOpend] = useState(false);
  const [commentText, setCommentText] = useState('');
  const { me } = useSelector((state) => state.user);
  const { commentAdded, isAddingComment } = useSelector((state) => state.post);
  const dispatch = useDispatch();

  const onToggleComment = useCallback(() => {
    setCommentFormOpend((prev) => !prev);
  }, []);

  const onSubmitComment = useCallback(
    (e) => {
      e.preventDefault();
      if (!me) {
        return alert('plz login.');
      }
      dispatch({
        type: ADD_COMMENT_REQUEST,
        payload: {
          postId: post.id,
        },
      });
    },
    [me && me.id],
  );

  const onChangeCommentText = useCallback((e) => {
    setCommentText(e.target.value);
  }, []);

  useEffect(() => {
    setCommentText('');
  }, [commentAdded === true]);

  return (
    <div>
      <Card
        key={+post.createdAt}
        cover={post.img && <img alt="example" src={post.img} />}
        actions={[
          <Icon type="retweet" key="retweet" />,
          <Icon type="heart" key="heart" />,
          <Icon type="message" key="message" onClick={onToggleComment} />,
          <Icon type="ellipsis" key="ellipsis" />,
        ]}
        extra={<Button>Follow</Button>}
      >
        <Card.Meta
          avatar={<Avatar>{post.User.nickname[0]}</Avatar>}
          title={post.User.nickname}
          description={post.content}
        />
      </Card>
      {commentFormOpend && (
        <>
          <Form onSubmit={onSubmitComment}>
            <Form.Item>
              <Input.TextArea
                row={4}
                value={commentText}
                onChange={onChangeCommentText}
              />
            </Form.Item>
            <Button type="primary" htmlType="submit" loading={isAddingComment}>
              twit
            </Button>
          </Form>
          <List
            header={`${post.Comments ? post.Comments.length : 0} comment`}
            itemLayout="horizontal"
            dataSource={post.Comments || []}
            renderItem={(item) => (
              <li>
                <Comment
                  author={item.User.nickname}
                  avatar={<Avatar>{item.User.nickname[0]}</Avatar>}
                  content={item.content}
                />
              </li>
            )}
          />
        </>
      )}
    </div>
  );
};

PostCard.propTypes = {
  post: PropTypes.shape({
    id: PropTypes.number,
    User: PropTypes.object,
    content: PropTypes.string,
    img: PropTypes.string,
    createdAt: PropTypes.object,
    Comments: PropTypes.object,
  }),
};

export default PostCard;

```
